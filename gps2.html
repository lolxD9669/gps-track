<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GPS â€“ Cel i odlegÅ‚oÅ›Ä‡ live</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script>
const TOKEN = "pk.eyJ1IjoicGlvdHJqZWxvbmVrIiwiYSI6ImNtaGhqaGhhOTA2dzUyanF3dDd5OWhydmMifQ._WbYeMoZH-HLItDZdKjGOg";
const refreshInterval = 1000; // 1 sekunda

// mapa
const map = L.map("map").setView([53.0857,-2.4393], 17);
L.tileLayer(
  `https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${TOKEN}`,
  { tileSize:512, zoomOffset:-1, attribution:"Â© Mapbox Â© OSM" }
).addTo(map);

// ikony
const redIcon = L.divIcon({ className:'marker-dot' });
const greenIcon = L.divIcon({ className:'target-dot' });

// obiekty
let myMarker = null;
let targetMarker = null;
let line = null;
let target = null;

// funkcja odlegÅ‚oÅ›ci (Haversine)
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = deg => deg * Math.PI/180;
  const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
  const Î”Ï† = toRad(lat2-lat1), Î”Î» = toRad(lon2-lon1);
  const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// aktualizacja pozycji
function updatePosition(lat, lon, acc) {
  if (!myMarker) {
    myMarker = L.marker([lat, lon], { icon: redIcon }).addTo(map);
  } else {
    myMarker.setLatLng([lat, lon]);
  }

  if (target) {
    if (line) map.removeLayer(line);
    line = L.polyline([[lat, lon], target], { color:"yellow", weight:2 }).addTo(map);

    const dist = haversine(lat, lon, target[0], target[1]);
    document.getElementById("info").innerHTML =
      `ğŸ“ Lat: ${lat.toFixed(6)} Lon: ${lon.toFixed(6)} Â±${Math.round(acc)} m<br>
       ğŸ¯ Cel: ${target[0].toFixed(6)}, ${target[1].toFixed(6)}<br>
       ğŸ“ OdlegÅ‚oÅ›Ä‡: <b>${dist.toFixed(1)} m</b>`;
  } else {
    document.getElementById("info").innerHTML =
      `Lat: ${lat.toFixed(6)} Lon: ${lon.toFixed(6)} Â±${Math.round(acc)} m<br>
       Brak ustawionego celu`;
  }
}

// zapisywanie celÃ³w
function saveTarget(lat, lon) {
  const stored = JSON.parse(localStorage.getItem("targets") || "[]");
  stored.unshift({lat, lon, time: new Date().toLocaleString()});
  const unique = stored.filter((v,i,a)=>
    a.findIndex(t=>t.lat===v.lat && t.lon===v.lon)===i
  );
  localStorage.setItem("targets", JSON.stringify(unique.slice(0,10))); // max 10
  loadTargets();
}

// wczytywanie listy celÃ³w
function loadTargets() {
  const select = document.getElementById("history");
  select.innerHTML = '<option value="">â€“ wybierz zapisany cel â€“</option>';
  const stored = JSON.parse(localStorage.getItem("targets") || "[]");
  for (const t of stored) {
    const opt = document.createElement("option");
    opt.value = `${t.lat},${t.lon}`;
    opt.textContent = `${t.lat.toFixed(5)}, ${t.lon.toFixed(5)} (${t.time})`;
    select.appendChild(opt);
  }
}

// ustawianie celu z inputÃ³w
document.getElementById("setTarget").addEventListener("click", () => {
  const lat = parseFloat(document.getElementById("latInput").value);
  const lon = parseFloat(document.getElementById("lonInput").value);
  if (isNaN(lat) || isNaN(lon)) { alert("Podaj poprawne wspÃ³Å‚rzÄ™dne!"); return; }
  target = [lat, lon];
  if (targetMarker) map.removeLayer(targetMarker);
  targetMarker = L.marker(target, { icon: greenIcon }).addTo(map);
  map.setView(target);
  saveTarget(lat, lon);
});

// wybÃ³r celu z historii
document.getElementById("history").addEventListener("change", e => {
  const val = e.target.value;
  if (!val) return;
  const [lat, lon] = val.split(",").map(parseFloat);
  target = [lat, lon];
  if (targetMarker) map.removeLayer(targetMarker);
  targetMarker = L.marker(target, { icon: greenIcon }).addTo(map);
  map.setView(target);
});

// start GPS (co 1 s)
if ("geolocation" in navigator) {
  navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      updatePosition(lat, lon, acc);
    },
    err => {
      document.getElementById("info").textContent =
        "BÅ‚Ä…d GPS: " + err.message;
    },
    { enableHighAccuracy: true, maximumAge: 0 }
  );
} else {
  document.getElementById("info").textContent =
    "Twoja przeglÄ…darka nie obsÅ‚uguje geolokalizacji.";
}

// zaÅ‚aduj historiÄ™ przy starcie
loadTargets();
</script>
</body>
</html>
