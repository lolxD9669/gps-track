<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GPS â€“ Cel i odlegÅ‚oÅ›Ä‡ live</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html,body{margin:0;height:100%;}
  #map{width:100%;height:100%;}
  #panel{
    position:absolute;top:10px;left:10px;
    background:rgba(0,0,0,0.6);color:white;
    padding:8px 12px;border-radius:8px;
    font-family:sans-serif;font-size:14px;
    z-index:1000;width:260px;
  }
  #panel input{
    width:100%;margin-top:4px;margin-bottom:4px;
    border:none;padding:4px;border-radius:4px;
  }
  #panel button{
    width:100%;padding:5px;margin-top:4px;
    border:none;background:#00aaff;color:white;
    border-radius:4px;cursor:pointer;
  }
  .marker-dot{
    width:14px;height:14px;background:red;
    border:2px solid white;border-radius:50%;
  }
  .target-dot{
    width:14px;height:14px;background:lime;
    border:2px solid white;border-radius:50%;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <div><b>Cel (lat, lon):</b></div>
  <input id="latInput" placeholder="53.014400">
  <input id="lonInput" placeholder="-2.427955">
  <button id="setTarget">Ustaw cel</button>
  <hr>
  <div id="info">Czekam na GPS...</div>
</div>

<script>
const TOKEN = "pk.eyJ1IjoicGlvdHJqZWxvbmVrIiwiYSI6ImNtaGhqaGhhOTA2dzUyanF3dDd5OWhydmMifQ._WbYeMoZH-HLItDZdKjGOg";
const refreshInterval = 1000; // 1 sekunda

// mapa
const map = L.map("map").setView([53.0857,-2.4393], 17);
L.tileLayer(
  `https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${TOKEN}`,
  { tileSize:512, zoomOffset:-1, attribution:"Â© Mapbox Â© OSM" }
).addTo(map);

// ikony
const redIcon = L.divIcon({ className:'marker-dot' });
const greenIcon = L.divIcon({ className:'target-dot' });

// obiekty
let myMarker = null;
let targetMarker = null;
let line = null;
let target = null;

// funkcja odlegÅ‚oÅ›ci
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = deg => deg * Math.PI/180;
  const Ï†1 = toRad(lat1), Ï†2 = toRad(lat2);
  const Î”Ï† = toRad(lat2-lat1), Î”Î» = toRad(lon2-lon1);
  const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// aktualizacja pozycji
function updatePosition(lat, lon, acc) {
  if (!myMarker) {
    myMarker = L.marker([lat, lon], { icon: redIcon }).addTo(map);
  } else {
    myMarker.setLatLng([lat, lon]);
  }

  if (target) {
    if (line) map.removeLayer(line);
    line = L.polyline([[lat, lon], target], { color:"yellow", weight:2 }).addTo(map);

    const dist = haversine(lat, lon, target[0], target[1]);
    document.getElementById("info").innerHTML =
      `ğŸ“ Lat: ${lat.toFixed(6)} Lon: ${lon.toFixed(6)} Â±${Math.round(acc)} m<br>
       ğŸ¯ Cel: ${target[0].toFixed(6)}, ${target[1].toFixed(6)}<br>
       ğŸ“ OdlegÅ‚oÅ›Ä‡: <b>${dist.toFixed(1)} m</b>`;
  } else {
    document.getElementById("info").innerHTML =
      `Lat: ${lat.toFixed(6)} Lon: ${lon.toFixed(6)} Â±${Math.round(acc)} m<br>
       Brak ustawionego celu`;
  }
}

// ustawianie celu z okienka
document.getElementById("setTarget").addEventListener("click", () => {
  const lat = parseFloat(document.getElementById("latInput").value);
  const lon = parseFloat(document.getElementById("lonInput").value);
  if (isNaN(lat) || isNaN(lon)) {
    alert("Podaj poprawne wspÃ³Å‚rzÄ™dne!");
    return;
  }
  target = [lat, lon];
  if (targetMarker) map.removeLayer(targetMarker);
  targetMarker = L.marker(target, { icon: greenIcon }).addTo(map);
  map.setView(target);
});

// obsÅ‚uga GPS (co sekundÄ™)
if ("geolocation" in navigator) {
  setInterval(() => {
    navigator.geolocation.watchPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        updatePosition(lat, lon, acc);
      },
      err => {
        document.getElementById("info").textContent =
          "BÅ‚Ä…d GPS: " + err.message;
      },
      { enableHighAccuracy: true, maximumAge: 0 , timeout:5000 }
    );
  }, refreshInterval);
} else {
  document.getElementById("info").textContent =
    "Twoja przeglÄ…darka nie obsÅ‚uguje geolokalizacji.";
}
</script>
</body>
</html>
